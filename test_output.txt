============================= test session starts ==============================
platform linux -- Python 3.14.2, pytest-9.0.2, pluggy-1.6.0
rootdir: /home/arc/Dev/tailor
configfile: pytest.ini
plugins: anyio-4.12.1, asyncio-1.3.0, mock-3.15.1, langsmith-0.6.4, cov-7.0.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 1 item

sidecar/tests/test_plugin_chat_branches.py 2026-01-23 12:32:29.512 | INFO     | sidecar.vault_brain:__init__:97 - VaultBrain Singleton created for: /home/arc/Dev/tailor/example-vault
2026-01-23 12:32:29.513 | INFO     | sidecar.vault_brain:initialize:132 - Starting VaultBrain initialization...
2026-01-23 12:32:29.592 | DEBUG    | sidecar.services.keyring_service:set_env_vars:266 - Set env var OPENAI_API_KEY
2026-01-23 12:32:29.608 | DEBUG    | sidecar.services.keyring_service:set_env_vars:266 - Set env var GOOGLE_API_KEY
2026-01-23 12:32:29.625 | DEBUG    | sidecar.services.keyring_service:set_env_vars:266 - Set env var OPENAI_API_KEY
2026-01-23 12:32:29.637 | DEBUG    | sidecar.services.keyring_service:set_env_vars:266 - Set env var GOOGLE_API_KEY
2026-01-23 12:32:29.645 | DEBUG    | sidecar.vault_brain:_load_plugins:231 - Scanning plugins directory: /home/arc/Dev/tailor/example-vault/plugins
2026-01-23 12:32:29.646 | DEBUG    | sidecar.api.plugin_base:__init__:65 - Plugin 'chat_branches' initialized (Passive)
2026-01-23 12:32:29.646 | DEBUG    | sidecar.vault_brain:register_command:372 - Registered command: branch.create
2026-01-23 12:32:29.646 | DEBUG    | sidecar.vault_brain:register_command:372 - Registered command: branch.switch
2026-01-23 12:32:29.646 | DEBUG    | sidecar.vault_brain:register_command:372 - Registered command: branch.list
2026-01-23 12:32:29.646 | INFO     | sidecar.vault_brain:_load_plugins:317 - Plugin 'chat_branches' loaded. Config: {'enabled': True}
2026-01-23 12:32:29.646 | DEBUG    | sidecar.vault_brain:_load_plugins:281 - Plugin 'demo_plugin' is disabled, skipping
2026-01-23 12:32:29.647 | DEBUG    | sidecar.api.plugin_base:__init__:65 - Plugin 'demo_ui' initialized (Passive)
2026-01-23 12:32:29.647 | INFO     | demo_ui:__init__:34 - Demo UI plugin initialized
2026-01-23 12:32:29.647 | DEBUG    | sidecar.vault_brain:register_command:372 - Registered command: demo_ui.show_modal
2026-01-23 12:32:29.647 | DEBUG    | sidecar.vault_brain:register_command:372 - Registered command: demo_ui.update_stage
2026-01-23 12:32:29.647 | DEBUG    | sidecar.vault_brain:register_command:372 - Registered command: demo_ui.toolbar_action
2026-01-23 12:32:29.647 | DEBUG    | demo_ui:register_commands:53 - Registered demo UI commands
2026-01-23 12:32:29.647 | INFO     | sidecar.vault_brain:_load_plugins:317 - Plugin 'demo_ui' loaded. Config: {'enabled': True}
2026-01-23 12:32:29.647 | DEBUG    | sidecar.vault_brain:_load_plugins:281 - Plugin 'event_test' is disabled, skipping
2026-01-23 12:32:29.647 | DEBUG    | sidecar.api.plugin_base:__init__:65 - Plugin 'explorer' initialized (Passive)
2026-01-23 12:32:29.647 | DEBUG    | sidecar.vault_brain:register_command:372 - Registered command: explorer.get_ui
2026-01-23 12:32:29.647 | INFO     | sidecar.vault_brain:_load_plugins:317 - Plugin 'explorer' loaded. Config: {'enabled': True}
2026-01-23 12:32:29.647 | DEBUG    | sidecar.api.plugin_base:__init__:65 - Plugin 'memory' initialized (Passive)
2026-01-23 12:32:29.647 | DEBUG    | sidecar.vault_brain:register_command:372 - Registered command: memory.load_chat
2026-01-23 12:32:29.647 | DEBUG    | sidecar.vault_brain:register_command:372 - Registered command: memory.save_chat
2026-01-23 12:32:29.648 | DEBUG    | sidecar.vault_brain:register_command:372 - Registered command: chat.get_history
2026-01-23 12:32:29.648 | INFO     | sidecar.vault_brain:_load_plugins:317 - Plugin 'memory' loaded. Config: {'enabled': True}
2026-01-23 12:32:29.648 | DEBUG    | sidecar.api.plugin_base:__init__:65 - Plugin 'prompt-refiner' initialized (Passive)
2026-01-23 12:32:29.648 | INFO     | prompt-refiner:__init__:63 - Prompt Refiner plugin initialized
2026-01-23 12:32:29.648 | DEBUG    | sidecar.vault_brain:register_command:372 - Registered command: refiner.refine
2026-01-23 12:32:29.648 | DEBUG    | sidecar.vault_brain:register_command:372 - Registered command: refiner.refine_from_ui
2026-01-23 12:32:29.648 | DEBUG    | prompt-refiner:register_commands:77 - Registered refiner.refine and refiner.refine_from_ui commands
2026-01-23 12:32:29.648 | INFO     | sidecar.vault_brain:_load_plugins:317 - Plugin 'prompt-refiner' loaded. Config: {'enabled': True}
2026-01-23 12:32:29.648 | DEBUG    | sidecar.api.plugin_base:__init__:65 - Plugin 'summarizer' initialized (Passive)
2026-01-23 12:32:29.649 | INFO     | summarizer:__init__:60 - Summarizer plugin initialized
2026-01-23 12:32:29.649 | DEBUG    | sidecar.vault_brain:register_command:372 - Registered command: summarizer.summarize
2026-01-23 12:32:29.649 | DEBUG    | sidecar.vault_brain:register_command:372 - Registered command: summarizer.delete_summary
2026-01-23 12:32:29.649 | DEBUG    | sidecar.vault_brain:register_command:372 - Registered command: summarizer.replace_message
2026-01-23 12:32:29.649 | DEBUG    | sidecar.vault_brain:register_command:372 - Registered command: summarizer.save_bookmark
2026-01-23 12:32:29.649 | INFO     | sidecar.vault_brain:_load_plugins:317 - Plugin 'summarizer' loaded. Config: {'enabled': True}
2026-01-23 12:32:29.649 | INFO     | sidecar.vault_brain:initialize:169 - VaultBrain configured: 6 plugins, 16 commands
2026-01-23 12:32:29.649 | INFO     | sidecar.vault_brain:_activate_plugins:327 - Activating plugins (calling on_load)...
2026-01-23 12:32:29.649 | INFO     | chat_branches:on_load:30 - Chat Branches Plugin loaded.
2026-01-23 12:32:29.649 | DEBUG    | sidecar.vault_brain:register_command:366 - Overriding command 'chat.get_history'
2026-01-23 12:32:29.649 | DEBUG    | sidecar.vault_brain:register_command:372 - Registered command: chat.get_history
2026-01-23 12:32:29.649 | DEBUG    | sidecar.event_bus:subscribe:40 - Subscribed to: pipeline.output (priority=5)
2026-01-23 12:32:29.649 | DEBUG    | sidecar.event_bus:subscribe:40 - Subscribed to: system:tick (priority=0)
2026-01-23 12:32:29.649 | DEBUG    | sidecar.api.plugin_base:on_load:100 - Plugin 'demo_ui' loaded (Active)
2026-01-23 12:32:29.649 | INFO     | demo_ui:on_load:175 - Demo UI plugin loaded
2026-01-23 12:32:29.649 | DEBUG    | sidecar.event_bus:subscribe:40 - Subscribed to: system:tick (priority=0)
2026-01-23 12:32:29.649 | DEBUG    | sidecar.api.plugin_base:on_load:100 - Plugin 'explorer' loaded (Active)
2026-01-23 12:32:29.649 | INFO     | explorer:on_load:64 - Explorer plugin fully loaded
2026-01-23 12:32:29.649 | DEBUG    | sidecar.event_bus:subscribe:40 - Subscribed to: system:tick (priority=0)
2026-01-23 12:32:29.649 | DEBUG    | sidecar.api.plugin_base:on_load:100 - Plugin 'memory' loaded (Active)
2026-01-23 12:32:29.649 | DEBUG    | sidecar.event_bus:subscribe:40 - Subscribed to: pipeline.output (priority=10)
2026-01-23 12:32:29.649 | INFO     | memory:on_load:37 - Memory Plugin loaded.
2026-01-23 12:32:29.649 | DEBUG    | sidecar.event_bus:subscribe:40 - Subscribed to: system:tick (priority=0)
2026-01-23 12:32:29.649 | DEBUG    | sidecar.api.plugin_base:on_load:100 - Plugin 'prompt-refiner' loaded (Active)
2026-01-23 12:32:29.649 | INFO     | prompt-refiner:on_load:207 - Prompt Refiner plugin loaded
2026-01-23 12:32:29.649 | DEBUG    | sidecar.event_bus:subscribe:40 - Subscribed to: system:tick (priority=0)
2026-01-23 12:32:29.649 | DEBUG    | sidecar.api.plugin_base:on_load:100 - Plugin 'summarizer' loaded (Active)
2026-01-23 12:32:29.649 | INFO     | summarizer:on_load:319 - Summarizer plugin loaded
2026-01-23 12:32:29.649 | DEBUG    | sidecar.event_bus:subscribe:40 - Subscribed to: system:tick (priority=0)
2026-01-23 12:32:29.650 | DEBUG    | sidecar.vault_brain:register_command:372 - Registered command: system.client_ready
2026-01-23 12:32:29.650 | DEBUG    | sidecar.vault_brain:register_command:372 - Registered command: chat.send
2026-01-23 12:32:29.650 | DEBUG    | sidecar.vault_brain:register_command:372 - Registered command: settings.delete_api_key
2026-01-23 12:32:29.650 | DEBUG    | sidecar.vault_brain:register_command:372 - Registered command: settings.detect_ollama
2026-01-23 12:32:29.650 | DEBUG    | sidecar.vault_brain:register_command:372 - Registered command: settings.get_available_models
2026-01-23 12:32:29.650 | DEBUG    | sidecar.vault_brain:register_command:372 - Registered command: system.info
2026-01-23 12:32:29.650 | DEBUG    | sidecar.vault_brain:register_command:372 - Registered command: settings.get_model_categories
2026-01-23 12:32:29.650 | DEBUG    | sidecar.vault_brain:register_command:372 - Registered command: system.chat
2026-01-23 12:32:29.650 | DEBUG    | sidecar.vault_brain:register_command:372 - Registered command: plugins.install
2026-01-23 12:32:29.650 | DEBUG    | sidecar.vault_brain:register_command:372 - Registered command: plugins.list
2026-01-23 12:32:29.650 | DEBUG    | sidecar.vault_brain:register_command:372 - Registered command: settings.list_providers
2026-01-23 12:32:29.650 | DEBUG    | sidecar.vault_brain:register_command:372 - Registered command: system.restart_vault
2026-01-23 12:32:29.650 | DEBUG    | sidecar.vault_brain:register_command:372 - Registered command: settings.set_model_category
2026-01-23 12:32:29.650 | DEBUG    | sidecar.vault_brain:register_command:372 - Registered command: settings.store_api_key
2026-01-23 12:32:29.650 | DEBUG    | sidecar.vault_brain:register_command:372 - Registered command: plugins.toggle
2026-01-23 12:32:29.650 | DEBUG    | sidecar.vault_brain:register_command:372 - Registered command: plugins.uninstall
2026-01-23 12:32:29.650 | DEBUG    | sidecar.vault_brain:register_command:372 - Registered command: plugins.update
2026-01-23 12:32:29.650 | DEBUG    | sidecar.vault_brain:register_command:372 - Registered command: settings.verify_api_key
2026-01-23 12:32:29.650 | INFO     | sidecar.vault_brain:initialize:181 - VaultBrain fully initialized and ready.
2026-01-23 12:32:29.651 | DEBUG    | sidecar.pipeline.default:run:137 - Invoking LangGraph...
2026-01-23 12:32:29.652 | DEBUG    | sidecar.pipeline.nodes:input_node:24 - Executing Input Node
2026-01-23 12:32:29.652 | DEBUG    | sidecar.pipeline.nodes:context_node:33 - Executing Context Node
2026-01-23 12:32:29.653 | DEBUG    | sidecar.pipeline.nodes:llm_node:55 - Executing LLM Node
2026-01-23 12:32:29.653 | DEBUG    | sidecar.services.llm_service:complete:372 - Completing with model: openai/gpt-4o-mini
2026-01-23 12:32:32.696 | DEBUG    | sidecar.pipeline.nodes:post_process_node:100 - Executing Post Process Node
2026-01-23 12:32:32.696 | DEBUG    | sidecar.pipeline.nodes:output_node:106 - Executing Output Node
2026-01-23 12:32:32.697 | DEBUG    | memory:save_chat:87 - Saved chat to chat_branch_plugin_test.json
2026-01-23 12:32:32.697 | INFO     | memory:save_interaction:154 - Saved interaction to chat_branch_plugin_test.json
2026-01-23 12:32:32.698 | ERROR    | chat_branches:create_branch:256 - Error creating branch: 'branches'
Traceback (most recent call last):
  File "/home/arc/Dev/tailor/example-vault/plugins/chat_branches/main.py", line 154, in create_branch
    data["branches"][root_id] = {
    ~~~~^^^^^^^^^^^^
KeyError: 'branches'

Branch Create Result 1: {'status': 'error', 'error': '\'branches\'\nTraceback (most recent call last):\n  File "/home/arc/Dev/tailor/example-vault/plugins/chat_branches/main.py", line 154, in create_branch\n    data["branches"][root_id] = {\n    ~~~~^^^^^^^^^^^^\nKeyError: \'branches\'\n'}
F

=================================== FAILURES ===================================
__________________________ test_plugin_chat_branches ___________________________

    @pytest.mark.asyncio
    async def test_plugin_chat_branches():
        """Test Chat Branches plugin with inline branch annotations."""
    
        # Setup test brain
        example_vault = Path(__file__).parent.parent.parent / "example-vault"
        brain = VaultBrain(example_vault, MagicMock())
    
        # Mock LLM
        with patch("sidecar.services.llm_service.LLMService") as MockLLM:
            mock_instance = MockLLM.return_value
            mock_instance.complete.return_value = MagicMock(content="Response", model="test", usage={})
    
            brain.llm = mock_instance
    
            # Initialize
            await brain.initialize()
    
            # Test chat ID
            chat_id = "chat_branch_plugin_test"
            memory_dir = example_vault / ".memory"
            memory_file = memory_dir / f"{chat_id}.json"
    
            # Clean up if exists
            if memory_file.exists():
                memory_file.unlink()
    
            # 1. Send initial message
            await brain.chat_send(message="Hello", chat_id=chat_id)
    
            # Verify messages stored
            assert memory_file.exists()
            with open(memory_file, "r") as f:
                data = json.load(f)
            assert "messages" in data
            assert len(data["messages"]) == 2
            msg_id = data["messages"][0]["id"]
    
            # 2. Create branch
            result = await brain.execute_command("branch.create",
                chat_id=chat_id,
                message_id=msg_id,
                branch_id="test_branch"
            )
            print(f"Branch Create Result 1: {result}")
>           assert result["status"] == "success", f"Branch creation failed: {result}"
E           AssertionError: Branch creation failed: {'status': 'error', 'error': '\'branches\'\nTraceback (most recent call last):\n  File "/home/arc/Dev/tailor/example-vault/plugins/chat_branches/main.py", line 154, in create_branch\n    data["branches"][root_id] = {\n    ~~~~^^^^^^^^^^^^\nKeyError: \'branches\'\n'}
E           assert 'error' == 'success'
E             
E             - success
E             + error

sidecar/tests/test_plugin_chat_branches.py:58: AssertionError
=============================== warnings summary ===============================
.pixi/envs/default/lib/python3.14/site-packages/langchain_core/_api/deprecation.py:26
  /home/arc/Dev/tailor/.pixi/envs/default/lib/python3.14/site-packages/langchain_core/_api/deprecation.py:26: UserWarning: Core Pydantic V1 functionality isn't compatible with Python 3.14 or greater.
    from pydantic.v1.fields import FieldInfo as FieldInfoV1

sidecar/tests/test_plugin_chat_branches.py::test_plugin_chat_branches
  /home/arc/Dev/tailor/.pixi/envs/default/lib/python3.14/site-packages/aiohttp/connector.py:993: DeprecationWarning: enable_cleanup_closed ignored because https://github.com/python/cpython/pull/118960 is fixed in Python version sys.version_info(major=3, minor=14, micro=2, releaselevel='final', serial=0)
    super().__init__(

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED sidecar/tests/test_plugin_chat_branches.py::test_plugin_chat_branches
======================== 1 failed, 2 warnings in 4.28s =========================
